(import
  (check)
  (zexy assemble)
  (zexy ops)
  (syntax))

(define-syntax check-assembles
  (lambda ($syntax)
    (syntax-case $syntax ()
      ((_ $op $data ...)
        #`(check
          (equal?
            (list
              #,@(map
                (lambda ($asm)
                  (syntax-case $asm (db dw)
                    ((db $expr) #`(list 'db $expr))
                    ((dw $expr) #`(list 'dw $expr))))
                (assemble #'$op)))
            (list (quote $data) ...)))))))

(define n12 #x12)
(define nm1234 #x1234)

(check-assembles (nop) (db 0))
(check-assembles (ret) (db #xc9))

(check-assembles (ld b b) (db #b01000000))
(check-assembles (ld b c) (db #b01000001))
(check-assembles (ld b d) (db #b01000010))
(check-assembles (ld b e) (db #b01000011))
(check-assembles (ld b h) (db #b01000100))
(check-assembles (ld b l) (db #b01000101))
(check-assembles (ld b (hl)) (db #b01000110))
(check-assembles (ld b a) (db #b01000111))

(check-assembles (ld c b) (db #b01001000))
(check-assembles (ld c c) (db #b01001001))
(check-assembles (ld c d) (db #b01001010))
(check-assembles (ld c e) (db #b01001011))
(check-assembles (ld c h) (db #b01001100))
(check-assembles (ld c l) (db #b01001101))
(check-assembles (ld c (hl)) (db #b01001110))
(check-assembles (ld c a) (db #b01001111))

(check-assembles (ld d b) (db #b01010000))
(check-assembles (ld d c) (db #b01010001))
(check-assembles (ld d d) (db #b01010010))
(check-assembles (ld d e) (db #b01010011))
(check-assembles (ld d h) (db #b01010100))
(check-assembles (ld d l) (db #b01010101))
(check-assembles (ld d (hl)) (db #b01010110))
(check-assembles (ld d a) (db #b01010111))

(check-assembles (ld e b) (db #b01011000))
(check-assembles (ld e c) (db #b01011001))
(check-assembles (ld e d) (db #b01011010))
(check-assembles (ld e e) (db #b01011011))
(check-assembles (ld e h) (db #b01011100))
(check-assembles (ld e l) (db #b01011101))
(check-assembles (ld e (hl)) (db #b01011110))
(check-assembles (ld e a) (db #b01011111))

(check-assembles (ld h b) (db #b01100000))
(check-assembles (ld h c) (db #b01100001))
(check-assembles (ld h d) (db #b01100010))
(check-assembles (ld h e) (db #b01100011))
(check-assembles (ld h h) (db #b01100100))
(check-assembles (ld h l) (db #b01100101))
(check-assembles (ld h (hl)) (db #b01100110))
(check-assembles (ld h a) (db #b01100111))

(check-assembles (ld l b) (db #b01101000))
(check-assembles (ld l c) (db #b01101001))
(check-assembles (ld l d) (db #b01101010))
(check-assembles (ld l e) (db #b01101011))
(check-assembles (ld l h) (db #b01101100))
(check-assembles (ld l l) (db #b01101101))
(check-assembles (ld l (hl)) (db #b01101110))
(check-assembles (ld l a) (db #b01101111))

(check-assembles (ld (hl) b) (db #b01110000))
(check-assembles (ld (hl) c) (db #b01110001))
(check-assembles (ld (hl) d) (db #b01110010))
(check-assembles (ld (hl) e) (db #b01110011))
(check-assembles (ld (hl) h) (db #b01110100))
(check-assembles (ld (hl) l) (db #b01110101))
(check-assembles (halt) (db #b01110110))
(check-assembles (ld (hl) a) (db #b01110111))

(check-assembles (ld a b) (db #b01111000))
(check-assembles (ld a c) (db #b01111001))
(check-assembles (ld a d) (db #b01111010))
(check-assembles (ld a e) (db #b01111011))
(check-assembles (ld a h) (db #b01111100))
(check-assembles (ld a l) (db #b01111101))
(check-assembles (ld a (hl)) (db #b01111110))
(check-assembles (ld a a) (db #b01111111))

(check-assembles (ld b n12) (db #b00000110) (db #x12))
(check-assembles (ld c n12) (db #b00001110) (db #x12))
(check-assembles (ld d n12) (db #b00010110) (db #x12))
(check-assembles (ld e n12) (db #b00011110) (db #x12))
(check-assembles (ld h n12) (db #b00100110) (db #x12))
(check-assembles (ld l n12) (db #b00101110) (db #x12))
(check-assembles (ld (hl) n12) (db #b00110110) (db #x12))
(check-assembles (ld a n12) (db #b00111110) (db #x12))

(check-assembles (ld a (bc)) (db #x0a))
(check-assembles (ld a (de)) (db #x1a))
(check-assembles (ld a (nm1234)) (db #x3a) (dw #x1234))

(check-assembles (ld (bc) a) (db #x02))
(check-assembles (ld (de) a) (db #x12))
(check-assembles (ld (nm1234) a) (db #x32) (dw #x1234))

(check-assembles (ld a i) (db #xed) (db #x57))
(check-assembles (ld a r) (db #xed) (db #x5f))
(check-assembles (ld i a) (db #xed) (db #x47))
(check-assembles (ld r a) (db #xed) (db #x4f))
